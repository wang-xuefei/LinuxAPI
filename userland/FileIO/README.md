# 通用的I/O模型

## [0x00]概述

所有执行I/O操作的系统调用都以文件描述符，一个非负整数(通常是小整数)，来指代打开的文件。文件描述符用以表示所有类型已打开文件，包括管道(pipe)、FIFO、socket、终端、设备和普通文件。针对每个进程，文件描述符都自成一套。

按照惯例，大多数程序都希望能够使用3种标准的文件描述符，如表1所示。在程序开始运行之前，shell代表程序打开这3个文件描述符。更确切的说，程序继承了shell文件描述符的副本，这3个描述符始终是打开的。如果命令行指定输入/输出进行重定向操作，那么shell会对文件描述符做适当修改，然后再启动程序。

| 文件描述符 |   用途   |   POSIX名称   | stdio流 |
| :--------: | :------: | :-----------: | :-----: |
|     0      | 标准输入 | STDIN_FILENO  |  stdin  |
|     1      | 标准输出 | STDOUT_FILENO | stdout  |
|     2      | 标准错误 | STDERR_FILENO | stderr  |

在程序指代这些描述符时，可以使用数字(0、1、2)表示，或者采用<unistd.h>所定义的POSIX标准名称。

虽然stdin、stdout和stderr变量在程序初始化时对用于指代进程的标准输入、标准输出和标准错误，但是调用freopen()库函数可以使这些变量指代其他任何文件对象。作为其操作的一部分，freopen()可以在将流(stream)重新打开之际一并更换隐匿其中的文件描述符。换言之，针对stdout调用freopen()函数后，无法保证stdout变量仍然为1。

## [0x01]通用I/O

UNIX I/O模型的显著特点之一是其输入输出的通用性概念。这意味着使用4个同样的系统调用open()、read()、write()和close()可以对所有类型的文件执行I/O操作，包括终端之类的设备。因此，仅使用这些系统调用编写程序，将对任何类型的文件有效。

要实现通用I/O，就必须确保每一个文件系统和设备驱动程序都实现了相同的I/O系统调用集。由于文件系统或设备锁特有的操作细节在内核中处理，在编程时通常可以忽略设备专有的因素。一旦应用程序要访问文件系统或设备的专有功能时，可以选择ioctl系统调用，这个调用为通用I/O模型之外的专有特性提供了访问接口。

## [0x02]打开一个文件：open()

open()调用既能打开一个已经存在的文件，也能创建并打开一个新文件。

```c
#include <sys/stat.h>
#include <fcntl.h>
int open(const char *pathname, int flags, .../* mode_t mode */);
		returns file descriptor on success, or -1 on error.
```

要打开的文件由参数pathname来标识。如果pathname是一个符号链接，会对其进行街引用。如果调用成功，open()将返回一个文件描述符，用于在后续函数调用中指代该文件。如果发生错误，则返回-1，并将errno设置为相应的错误标志。

参数flags是位掩码，用于指定文件的访问模式，可选择下表所示的常量之一。(早期的UNIX实现中使用数字0、1、2，而不是下表中列的常量名称。大多数现代UNIX实现将这些常量定义为上述相应数字。由此可见，O_RDWR并不等同于O_RDONLY | O_WRONLY，后者组合属于逻辑错误。

| 访问模式 |       描述       |
| :------: | :--------------: |
| O_RDONLY | 以只读的方式打开 |
| O_WRONLY | 以只写的方式打开 |
|  O_RDWR  | 以读写的方式打开 |

当调用open()创建新文件时，位掩码参数mode指定了文件的访问权限。(SUSv3规定，mode的数据类型mode_t属于整数类型)如果open()并未指定O_CREAT标志，则可以省略mode参数。

### open()调用锁返回的文件描述符数值

SUSv3规定，如果调用open()成功，必须保证他的返回值为进程未使用文件描述符中数值最小者。可以利用这个特点以特定文件描述符打开一个文件。

### open()调用中的flags参数

在open()调用例子中，flags参数除了使用文件访问标志外，还使用了其他操作标志(O_CREAT、O_TRUNC和O_APPEND)。现在讲详细介绍flags参数。下表总结了可参与flags参数逐位或运算(|)的一整套常量。最后一列显示常量标准化与SUSv3还是SUSv4。

|    标志     |                            用途                             | 统一UNIX规范版本 |
| :---------: | :---------------------------------------------------------: | ---------------- |
|  O_RDONLY   |                       以只读方式打开                        | v3               |
|  O_WRONLY   |                       以只写方式打开                        | v3               |
|   O_RDWR    |                       以读写方式打开                        | v3               |
| O_CLOSEXEC  |        设置close-on-exec标志(自Linux 2.6.32版本开始)        | v4               |
|   O_CREAT   |                     若文件不存在则创建                      | v3               |
|   O_DRECT   |                      无缓冲的输入/输出                      |                  |
| O_DRECTORY  |                如果pathname不是目录，则失败                 | v4               |
|   O_EXECL   |            结合O_CREAT参数使用，专门用于创建文件            | v3               |
| O_LARGEFILE |             在32位系统中使用这个标志打开大文件              |                  |
|  O_NOATIME  | 调用read()时，不修改文件最近访问时间(自Linux 2.6.8版本开始) |                  |
|  O_NOCTTY   |        不要让pathname(所指向的终端设备)成为控制终端         | v3               |
| O_NOFOLLOW  |                    对符号链接不予解引用                     | v4               |
|   O_TRUNC   |                  截断已有文件，使其长度为0                  | v3               |
|  O_APPEND   |                    总在文件尾部追加数据                     | v3               |
|   O_ASYNC   |          当I/O操作可行时，产生信号(signal)通知进程          |                  |
|   O_DSYNC   |      提供同步的I/O数据完整性(自 Linux 2.6.33版本开始)       | v3               |
| O_NONBLOCK  |                      以非阻塞方式打开                       | v3               |
|   O_SYNC    |                     以同步方式写入文件                      | v3               |

上表中常量分为如下几组：

- 文件访问模式标志：先前描述的O_RDONLY、O_WRONLY和O_RDWR标志都在这列，调用open()时，上述三者在flags参数中不能同时使用，只能指定其中一种。调用fcntl()的F_GETFL操作能够检索文件的访问模式。
- 文件创建标志：这些标志在上表中位于第二部分，控制范围不局限于open()调用行为的方方面面，还涉及后续I/O操作的各个选项。这些标志不能检索，也无法修改。
- 已打开文件的状态标志：这些标志是上表中的剩余部分，使用fcntl()的F_GETFL和F_SETFL操作可以分别检索和修改这类标志。有事干脆将其称之为文件状态标志。

始于内核版本2.6.22，读取位于/proc/PID/fdinfo目录下的linux系统专有文件，可以获取系统内任一进程中文件描述符的相关信息。针对进程中每一个已经打开的文件描述符，该目录下都有相应的文件，一对应文件描述符的数值命名。文件中的pos字段表示当前的文件偏移量。而flags字段则为一个8进制数，表征文件访问标志和已打开文件的状态标志。

